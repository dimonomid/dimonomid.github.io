<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>TNeoKernel: Unit tests</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-7163754-5', 'auto');
  ga('send', 'pageview');
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">TNeoKernel
   &#160;<span id="projectnumber">v1.03</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Unit tests </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Brief information on the implementation of unit tests</p>
<h1><a class="anchor" id="how_tests_are_implemented"></a>
How tests are implemented</h1>
<p>Briefly: there is a high-priority task like "test director", which creates worker tasks as well as various kernel objects (queues, mutexes, etc), and then orders to workers, like:</p>
<ul>
<li>Task A, you lock the mutex M1</li>
<li>Task B, you lock the mutex M1</li>
<li>Task C, you lock the mutex M1</li>
<li>Task A, you delete the mutex M1</li>
</ul>
<p>After each step it waits for workers to complete their job, and then checks if things are as expected: task states, task priorities, last return values of services, various properties of objects, etc.</p>
<p>Detailed log is written to the UART. Typically, for each step, the following is written:</p>
<ul>
<li>verbatim comment is written,</li>
<li>director writes what does it do,</li>
<li>each worker writes what does it do,</li>
<li>director checks things and writes detailed report.</li>
</ul>
<p>Of course there is a mechanism for writing such scenarios. Here is a part of code that specifies the sequence with locking and deleting mutex explained above:</p>
<div class="fragment"><div class="line">TNT_TEST_COMMENT(<span class="stringliteral">&quot;A locks M1&quot;</span>);</div>
<div class="line">TNT_ITEM__SEND_CMD_MUTEX(TNT_TASK__A, MUTEX_LOCK, TNT_MUTEX__1);</div>
<div class="line">TNT_ITEM__WAIT_AND_CHECK_DIFF(</div>
<div class="line">      TNT_CHECK__MUTEX(TNT_MUTEX__1, HOLDER, TNT_TASK__A);</div>
<div class="line">      TNT_CHECK__MUTEX(TNT_MUTEX__1, LOCK_CNT, 1);</div>
<div class="line"></div>
<div class="line">      TNT_CHECK__TASK(TNT_TASK__A, LAST_RETVAL, <a class="code" href="tn__common_8h.html#aa43bd3da1ad4c1e61224b5f23b369876afb291924237186f5765865256c75e639">TN_RC_OK</a>);</div>
<div class="line">      );</div>
<div class="line"></div>
<div class="line">TNT_TEST_COMMENT(<span class="stringliteral">&quot;B tries to lock M1 -&gt; B blocks, A has priority of B&quot;</span>);</div>
<div class="line">TNT_ITEM__SEND_CMD_MUTEX(TNT_TASK__B, MUTEX_LOCK, TNT_MUTEX__1);</div>
<div class="line">TNT_ITEM__WAIT_AND_CHECK_DIFF(</div>
<div class="line">      TNT_CHECK__TASK(TNT_TASK__B, LAST_RETVAL, TWORKER_MAN__LAST_RETVAL__UNKNOWN);</div>
<div class="line">      TNT_CHECK__TASK(TNT_TASK__B, WAIT_REASON, <a class="code" href="tn__oldsymbols_8h.html#a1d72794d5d13225327301cce148c4676">TSK_WAIT_REASON_MUTEX_I</a>);</div>
<div class="line"></div>
<div class="line">      TNT_CHECK__TASK(TNT_TASK__A, PRIORITY, priority_task_b);</div>
<div class="line">      );</div>
<div class="line"></div>
<div class="line">TNT_TEST_COMMENT(<span class="stringliteral">&quot;C tries to lock M1 -&gt; C blocks, A has priority of C&quot;</span>);</div>
<div class="line">TNT_ITEM__SEND_CMD_MUTEX(TNT_TASK__C, MUTEX_LOCK, TNT_MUTEX__1);</div>
<div class="line">TNT_ITEM__WAIT_AND_CHECK_DIFF(</div>
<div class="line">      TNT_CHECK__TASK(TNT_TASK__C, LAST_RETVAL, TWORKER_MAN__LAST_RETVAL__UNKNOWN);</div>
<div class="line">      TNT_CHECK__TASK(TNT_TASK__C, WAIT_REASON, <a class="code" href="tn__oldsymbols_8h.html#a1d72794d5d13225327301cce148c4676">TSK_WAIT_REASON_MUTEX_I</a>);</div>
<div class="line"></div>
<div class="line">      TNT_CHECK__TASK(TNT_TASK__A, PRIORITY, priority_task_c);</div>
<div class="line">      );</div>
<div class="line"></div>
<div class="line">TNT_TEST_COMMENT(<span class="stringliteral">&quot;A deleted M1 -&gt; B and C become runnable and have retval TN_RC_DELETED, A has its base priority&quot;</span>);</div>
<div class="line">TNT_ITEM__SEND_CMD_MUTEX(TNT_TASK__A, MUTEX_DELETE, TNT_MUTEX__1);</div>
<div class="line">TNT_ITEM__WAIT_AND_CHECK_DIFF(</div>
<div class="line">      TNT_CHECK__TASK(TNT_TASK__B, LAST_RETVAL, <a class="code" href="tn__common_8h.html#aa43bd3da1ad4c1e61224b5f23b369876a3252967d2fdefcfbd4eb720ed4663d84">TN_RC_DELETED</a>);</div>
<div class="line">      TNT_CHECK__TASK(TNT_TASK__C, LAST_RETVAL, <a class="code" href="tn__common_8h.html#aa43bd3da1ad4c1e61224b5f23b369876a3252967d2fdefcfbd4eb720ed4663d84">TN_RC_DELETED</a>);</div>
<div class="line">      TNT_CHECK__TASK(TNT_TASK__B, WAIT_REASON, <a class="code" href="tn__oldsymbols_8h.html#a56aeec64ffd044ed5fb917eb415ea889">TSK_WAIT_REASON_DQUE_WRECEIVE</a>);</div>
<div class="line">      TNT_CHECK__TASK(TNT_TASK__C, WAIT_REASON, <a class="code" href="tn__oldsymbols_8h.html#a56aeec64ffd044ed5fb917eb415ea889">TSK_WAIT_REASON_DQUE_WRECEIVE</a>);</div>
<div class="line"></div>
<div class="line">      TNT_CHECK__TASK(TNT_TASK__A, PRIORITY, priority_task_a);</div>
<div class="line"></div>
<div class="line">      TNT_CHECK__MUTEX(TNT_MUTEX__1, HOLDER, TNT_TASK__NONE);</div>
<div class="line">      TNT_CHECK__MUTEX(TNT_MUTEX__1, LOCK_CNT, 0);</div>
<div class="line">      TNT_CHECK__MUTEX(TNT_MUTEX__1, EXISTS, 0);</div>
<div class="line">      );</div>
</div><!-- fragment --><p>And here is the appropriate part of log that is echoed to the UART:</p>
<div class="fragment"><div class="line"><span class="comment">//-- A locks M1 (line 404 in ../source/appl/appl_tntest/appl_tntest_mutex.c) </span></div>
<div class="line">[I]: tnt_item_proceed():2101: ----- Command to task A: lock mutex M1 (0xa0004c40) </div>
<div class="line">[I]: tnt_item_proceed():2160: Wait 80 ticks </div>
<div class="line">[I]: [Task A]: locking mutex (0xa0004c40).. </div>
<div class="line">[I]: [Task A]: mutex (0xa0004c40) locked </div>
<div class="line">[I]: [Task A]: waiting for command.. </div>
<div class="line">[I]: tnt_item_proceed():2178: Checking: </div>
<div class="line">[I]: * Task A: priority=6 (as expected), wait_reason=DQUE_WRECEIVE (as expected), last_retval=<a class="code" href="tn__common_8h.html#aa43bd3da1ad4c1e61224b5f23b369876afb291924237186f5765865256c75e639">TN_RC_OK</a> (as expected) </div>
<div class="line">[I]: * Task B: priority=5 (as expected), wait_reason=DQUE_WRECEIVE (as expected), last_retval=NOT-YET-RECEIVED (as expected) </div>
<div class="line">[I]: * Task C: priority=4 (as expected), wait_reason=DQUE_WRECEIVE (as expected), last_retval=NOT-YET-RECEIVED (as expected) </div>
<div class="line">[I]: * Mutex M1: holder=A (as expected), lock_cnt=1 (as expected), exists=yes (as expected) </div>
<div class="line"></div>
<div class="line"><span class="comment">//-- B tries to lock M1 -&gt; B blocks, A has priority of B (line 413 in ../source/appl/appl_tntest/appl_tntest_mutex.c) </span></div>
<div class="line">[I]: tnt_item_proceed():2101: ----- Command to task B: lock mutex M1 (0xa0004c40) </div>
<div class="line">[I]: tnt_item_proceed():2160: Wait 80 ticks </div>
<div class="line">[I]: [Task B]: locking mutex (0xa0004c40).. </div>
<div class="line">[I]: tnt_item_proceed():2178: Checking: </div>
<div class="line">[I]: * Task A: priority=5 (as expected), wait_reason=DQUE_WRECEIVE (as expected), last_retval=<a class="code" href="tn__common_8h.html#aa43bd3da1ad4c1e61224b5f23b369876afb291924237186f5765865256c75e639">TN_RC_OK</a> (as expected) </div>
<div class="line">[I]: * Task B: priority=5 (as expected), wait_reason=MUTEX_I (as expected), last_retval=NOT-YET-RECEIVED (as expected) </div>
<div class="line">[I]: * Task C: priority=4 (as expected), wait_reason=DQUE_WRECEIVE (as expected), last_retval=NOT-YET-RECEIVED (as expected) </div>
<div class="line">[I]: * Mutex M1: holder=A (as expected), lock_cnt=1 (as expected), exists=yes (as expected) </div>
<div class="line"></div>
<div class="line"><span class="comment">//-- C tries to lock M1 -&gt; B blocks, A has priority of C (line 422 in ../source/appl/appl_tntest/appl_tntest_mutex.c) </span></div>
<div class="line">[I]: tnt_item_proceed():2101: ----- Command to task C: lock mutex M1 (0xa0004c40) </div>
<div class="line">[I]: tnt_item_proceed():2160: Wait 80 ticks </div>
<div class="line">[I]: [Task C]: locking mutex (0xa0004c40).. </div>
<div class="line">[I]: tnt_item_proceed():2178: Checking: </div>
<div class="line">[I]: * Task A: priority=4 (as expected), wait_reason=DQUE_WRECEIVE (as expected), last_retval=<a class="code" href="tn__common_8h.html#aa43bd3da1ad4c1e61224b5f23b369876afb291924237186f5765865256c75e639">TN_RC_OK</a> (as expected) </div>
<div class="line">[I]: * Task B: priority=5 (as expected), wait_reason=MUTEX_I (as expected), last_retval=NOT-YET-RECEIVED (as expected) </div>
<div class="line">[I]: * Task C: priority=4 (as expected), wait_reason=MUTEX_I (as expected), last_retval=NOT-YET-RECEIVED (as expected) </div>
<div class="line">[I]: * Mutex M1: holder=A (as expected), lock_cnt=1 (as expected), exists=yes (as expected) </div>
<div class="line"></div>
<div class="line"><span class="comment">//-- A deleted M1 -&gt; B and C become runnable and have retval TN_RC_DELETED, A has its base priority (line 431 in ../source/appl/appl_tntest/appl_tntest_mutex.c) </span></div>
<div class="line">[I]: tnt_item_proceed():2101: ----- Command to task A: delete mutex M1 (0xa0004c40) </div>
<div class="line">[I]: tnt_item_proceed():2160: Wait 80 ticks </div>
<div class="line">[I]: [Task A]: deleting mutex (0xa0004c40).. </div>
<div class="line">[I]: [Task C]: mutex (0xa0004c40) locking failed with err=-8 </div>
<div class="line">[I]: [Task C]: waiting for command.. </div>
<div class="line">[I]: [Task B]: mutex (0xa0004c40) locking failed with err=-8 </div>
<div class="line">[I]: [Task B]: waiting for command.. </div>
<div class="line">[I]: [Task A]: mutex (0xa0004c40) deleted </div>
<div class="line">[I]: [Task A]: waiting for command.. </div>
<div class="line">[I]: tnt_item_proceed():2178: Checking: </div>
<div class="line">[I]: * Task A: priority=6 (as expected), wait_reason=DQUE_WRECEIVE (as expected), last_retval=<a class="code" href="tn__common_8h.html#aa43bd3da1ad4c1e61224b5f23b369876afb291924237186f5765865256c75e639">TN_RC_OK</a> (as expected) </div>
<div class="line">[I]: * Task B: priority=5 (as expected), wait_reason=DQUE_WRECEIVE (as expected), last_retval=<a class="code" href="tn__common_8h.html#aa43bd3da1ad4c1e61224b5f23b369876a3252967d2fdefcfbd4eb720ed4663d84">TN_RC_DELETED</a> (as expected) </div>
<div class="line">[I]: * Task C: priority=4 (as expected), wait_reason=DQUE_WRECEIVE (as expected), last_retval=<a class="code" href="tn__common_8h.html#aa43bd3da1ad4c1e61224b5f23b369876a3252967d2fdefcfbd4eb720ed4663d84">TN_RC_DELETED</a> (as expected) </div>
<div class="line">[I]: * Mutex M1: holder=NONE (as expected), lock_cnt=0 (as expected), exists=no (as expected) </div>
</div><!-- fragment --><p>If something goes wrong, there would be no <code>"as expected"</code>, but error and explanation what we expected and what we have. Tests halted.</p>
<p>I do my best to model nearly all possible situations within the each single subsystem (such as mutexes, queues, etc), including various situations with suspended tasks, deleted tasks, deleted objects, and the like. It helps a lot to keep the kernel really stable.</p>
<h1><a class="anchor" id="get_tests"></a>
Get unit-tests</h1>
<p>Currently, there is a separate repository with unit tests for TNeoKernel.</p>
<p>Please note that code of unit tests project is not as polished as the code of the kernel itself. My open-source time is limited, and I prefer to invest it in the kernel as much as possible.</p>
<p>Nevertheless, unit tests do their job efficiently, which is needed.</p>
<p>There is an "environment" repository, which contains tests and all the necessary library subrepos: <a href="http://hg.dfrank.ru/tntest/_env">http://hg.dfrank.ru/tntest/_env</a></p>
<p>You can clone it as follows: </p><pre class="fragment">hg clone http://hg.dfrank.ru/tntest/_env tntest
</pre><p>The single repository with the tests resides here: <a href="http://hg.dfrank.ru/tntest/project_common">http://hg.dfrank.ru/tntest/project_common</a> </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Oct 20 2014 18:23:46 for TNeoKernel by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.8
</small></address>
</body>
</html>
