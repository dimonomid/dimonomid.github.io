\hypertarget{tn__arch_8h}{\section{arch/tn\+\_\+arch.h File Reference}
\label{tn__arch_8h}\index{arch/tn\+\_\+arch.\+h@{arch/tn\+\_\+arch.\+h}}
}


\subsection{Detailed Description}
Architecture-\/dependent routines declaration. 



Definition in file \hyperlink{tn__arch_8h_source}{tn\+\_\+arch.\+h}.

\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hypertarget{tn__arch_8h_a2b3f2294ac42a599662c573394b14c75}{void \hyperlink{tn__arch_8h_a2b3f2294ac42a599662c573394b14c75}{tn\+\_\+arch\+\_\+int\+\_\+dis} (void)}\label{tn__arch_8h_a2b3f2294ac42a599662c573394b14c75}

\begin{DoxyCompactList}\small\item\em Unconditionally disable interrupts. \end{DoxyCompactList}\item 
\hypertarget{tn__arch_8h_a2997c6d98ac43cb90216fc4e8137bcfb}{void \hyperlink{tn__arch_8h_a2997c6d98ac43cb90216fc4e8137bcfb}{tn\+\_\+arch\+\_\+int\+\_\+en} (void)}\label{tn__arch_8h_a2997c6d98ac43cb90216fc4e8137bcfb}

\begin{DoxyCompactList}\small\item\em Unconditionally enable interrupts. \end{DoxyCompactList}\item 
\hyperlink{tn__arch__example_8h_ab80cba0fe9ffcd9011d53dfeb9e39bf4}{T\+N\+\_\+\+U\+Word} \hyperlink{tn__arch_8h_a7078b776570ca67a51b89d2746bdb6f7}{tn\+\_\+arch\+\_\+sr\+\_\+save\+\_\+int\+\_\+dis} (void)
\begin{DoxyCompactList}\small\item\em Disable interrupts and return previous value of status register, atomically. \end{DoxyCompactList}\item 
void \hyperlink{tn__arch_8h_aa755327bd8c4e4303c87c2b0cbed0f17}{tn\+\_\+arch\+\_\+sr\+\_\+restore} (\hyperlink{tn__arch__example_8h_ab80cba0fe9ffcd9011d53dfeb9e39bf4}{T\+N\+\_\+\+U\+Word} sr)
\begin{DoxyCompactList}\small\item\em Restore previously saved status register. \end{DoxyCompactList}\item 
\hyperlink{tn__arch__example_8h_ab80cba0fe9ffcd9011d53dfeb9e39bf4}{T\+N\+\_\+\+U\+Word} $\ast$ \hyperlink{tn__arch_8h_a8b4910c153815699beca8afdea88e4b5}{\+\_\+tn\+\_\+arch\+\_\+stack\+\_\+top\+\_\+get} (\hyperlink{tn__arch__example_8h_ab80cba0fe9ffcd9011d53dfeb9e39bf4}{T\+N\+\_\+\+U\+Word} $\ast$stack\+\_\+low\+\_\+address, int stack\+\_\+size)
\begin{DoxyCompactList}\small\item\em Should return top of the stack, which may be either\+: \end{DoxyCompactList}\item 
\hyperlink{tn__arch__example_8h_ab80cba0fe9ffcd9011d53dfeb9e39bf4}{T\+N\+\_\+\+U\+Word} $\ast$ \hyperlink{tn__arch_8h_a2bf8e2e89bfb1264528e4ce23a6757e3}{\+\_\+tn\+\_\+arch\+\_\+stack\+\_\+init} (\hyperlink{tn__common_8h_a82f7de9034cbbb373c4dbcff45942343}{T\+N\+\_\+\+Task\+Body} $\ast$task\+\_\+func, \hyperlink{tn__arch__example_8h_ab80cba0fe9ffcd9011d53dfeb9e39bf4}{T\+N\+\_\+\+U\+Word} $\ast$stack\+\_\+top, void $\ast$param)
\begin{DoxyCompactList}\small\item\em Should put initial C\+P\+U context to the provided stack pointer for new task and return current stack pointer. \end{DoxyCompactList}\item 
\hypertarget{tn__arch_8h_a34ffbae8b6837f7f3014bca9991e2272}{int \hyperlink{tn__arch_8h_a34ffbae8b6837f7f3014bca9991e2272}{\+\_\+tn\+\_\+arch\+\_\+inside\+\_\+isr} (void)}\label{tn__arch_8h_a34ffbae8b6837f7f3014bca9991e2272}

\begin{DoxyCompactList}\small\item\em Should return 1 if I\+S\+R is currently running, 0 otherwise. \end{DoxyCompactList}\item 
void \hyperlink{tn__arch_8h_a28871f82c82d549092930dd4842e2980}{\+\_\+tn\+\_\+arch\+\_\+context\+\_\+switch\+\_\+pend} (void)
\begin{DoxyCompactList}\small\item\em Called whenever we need to switch context from one task to another. \end{DoxyCompactList}\item 
void \hyperlink{tn__arch_8h_afd5f43f42f5645de164ba6d13d3a4bcf}{\+\_\+tn\+\_\+arch\+\_\+context\+\_\+switch\+\_\+now\+\_\+nosave} (void)
\begin{DoxyCompactList}\small\item\em Called whenever we need to switch context to new task, but don't save current context. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Function Documentation}
\hypertarget{tn__arch_8h_a7078b776570ca67a51b89d2746bdb6f7}{\index{tn\+\_\+arch.\+h@{tn\+\_\+arch.\+h}!tn\+\_\+arch\+\_\+sr\+\_\+save\+\_\+int\+\_\+dis@{tn\+\_\+arch\+\_\+sr\+\_\+save\+\_\+int\+\_\+dis}}
\index{tn\+\_\+arch\+\_\+sr\+\_\+save\+\_\+int\+\_\+dis@{tn\+\_\+arch\+\_\+sr\+\_\+save\+\_\+int\+\_\+dis}!tn\+\_\+arch.\+h@{tn\+\_\+arch.\+h}}
\subsubsection[{tn\+\_\+arch\+\_\+sr\+\_\+save\+\_\+int\+\_\+dis}]{\setlength{\rightskip}{0pt plus 5cm}{\bf T\+N\+\_\+\+U\+Word} tn\+\_\+arch\+\_\+sr\+\_\+save\+\_\+int\+\_\+dis (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}}\label{tn__arch_8h_a7078b776570ca67a51b89d2746bdb6f7}


Disable interrupts and return previous value of status register, atomically. 

\begin{DoxySeeAlso}{See also}
{\ttfamily \hyperlink{tn__arch_8h_aa755327bd8c4e4303c87c2b0cbed0f17}{tn\+\_\+arch\+\_\+sr\+\_\+restore()}} 
\end{DoxySeeAlso}
\hypertarget{tn__arch_8h_aa755327bd8c4e4303c87c2b0cbed0f17}{\index{tn\+\_\+arch.\+h@{tn\+\_\+arch.\+h}!tn\+\_\+arch\+\_\+sr\+\_\+restore@{tn\+\_\+arch\+\_\+sr\+\_\+restore}}
\index{tn\+\_\+arch\+\_\+sr\+\_\+restore@{tn\+\_\+arch\+\_\+sr\+\_\+restore}!tn\+\_\+arch.\+h@{tn\+\_\+arch.\+h}}
\subsubsection[{tn\+\_\+arch\+\_\+sr\+\_\+restore}]{\setlength{\rightskip}{0pt plus 5cm}void tn\+\_\+arch\+\_\+sr\+\_\+restore (
\begin{DoxyParamCaption}
\item[{{\bf T\+N\+\_\+\+U\+Word}}]{sr}
\end{DoxyParamCaption}
)}}\label{tn__arch_8h_aa755327bd8c4e4303c87c2b0cbed0f17}


Restore previously saved status register. 


\begin{DoxyParams}{Parameters}
{\em sr} & status register value previously from {\ttfamily \hyperlink{tn__arch_8h_a7078b776570ca67a51b89d2746bdb6f7}{tn\+\_\+arch\+\_\+sr\+\_\+save\+\_\+int\+\_\+dis()}}\\
\hline
\end{DoxyParams}
\begin{DoxySeeAlso}{See also}
{\ttfamily \hyperlink{tn__arch_8h_a7078b776570ca67a51b89d2746bdb6f7}{tn\+\_\+arch\+\_\+sr\+\_\+save\+\_\+int\+\_\+dis()}} 
\end{DoxySeeAlso}
\hypertarget{tn__arch_8h_a8b4910c153815699beca8afdea88e4b5}{\index{tn\+\_\+arch.\+h@{tn\+\_\+arch.\+h}!\+\_\+tn\+\_\+arch\+\_\+stack\+\_\+top\+\_\+get@{\+\_\+tn\+\_\+arch\+\_\+stack\+\_\+top\+\_\+get}}
\index{\+\_\+tn\+\_\+arch\+\_\+stack\+\_\+top\+\_\+get@{\+\_\+tn\+\_\+arch\+\_\+stack\+\_\+top\+\_\+get}!tn\+\_\+arch.\+h@{tn\+\_\+arch.\+h}}
\subsubsection[{\+\_\+tn\+\_\+arch\+\_\+stack\+\_\+top\+\_\+get}]{\setlength{\rightskip}{0pt plus 5cm}{\bf T\+N\+\_\+\+U\+Word}$\ast$ \+\_\+tn\+\_\+arch\+\_\+stack\+\_\+top\+\_\+get (
\begin{DoxyParamCaption}
\item[{{\bf T\+N\+\_\+\+U\+Word} $\ast$}]{stack\+\_\+low\+\_\+address, }
\item[{int}]{stack\+\_\+size}
\end{DoxyParamCaption}
)}}\label{tn__arch_8h_a8b4910c153815699beca8afdea88e4b5}


Should return top of the stack, which may be either\+: 


\begin{DoxyItemize}
\item {\ttfamily (stack\+\_\+low\+\_\+address -\/ 1)}
\item {\ttfamily (stack\+\_\+low\+\_\+address + stack\+\_\+size)}
\end{DoxyItemize}

(depending on the architecture)

{\bfseries N\+O\+T\+E} that returned {\itshape top of the stack} is N\+O\+T the address which may be used for storing the new data. Instead, it is the {\itshape previous} address.


\begin{DoxyParams}{Parameters}
{\em stack\+\_\+low\+\_\+address} & start address of the stack array. \\
\hline
{\em stack\+\_\+size} & size of the stack in {\ttfamily \hyperlink{tn__arch__example_8h_ab80cba0fe9ffcd9011d53dfeb9e39bf4}{T\+N\+\_\+\+U\+Word}}-\/s, not in bytes. \\
\hline
\end{DoxyParams}
\hypertarget{tn__arch_8h_a2bf8e2e89bfb1264528e4ce23a6757e3}{\index{tn\+\_\+arch.\+h@{tn\+\_\+arch.\+h}!\+\_\+tn\+\_\+arch\+\_\+stack\+\_\+init@{\+\_\+tn\+\_\+arch\+\_\+stack\+\_\+init}}
\index{\+\_\+tn\+\_\+arch\+\_\+stack\+\_\+init@{\+\_\+tn\+\_\+arch\+\_\+stack\+\_\+init}!tn\+\_\+arch.\+h@{tn\+\_\+arch.\+h}}
\subsubsection[{\+\_\+tn\+\_\+arch\+\_\+stack\+\_\+init}]{\setlength{\rightskip}{0pt plus 5cm}{\bf T\+N\+\_\+\+U\+Word}$\ast$ \+\_\+tn\+\_\+arch\+\_\+stack\+\_\+init (
\begin{DoxyParamCaption}
\item[{{\bf T\+N\+\_\+\+Task\+Body} $\ast$}]{task\+\_\+func, }
\item[{{\bf T\+N\+\_\+\+U\+Word} $\ast$}]{stack\+\_\+top, }
\item[{void $\ast$}]{param}
\end{DoxyParamCaption}
)}}\label{tn__arch_8h_a2bf8e2e89bfb1264528e4ce23a6757e3}


Should put initial C\+P\+U context to the provided stack pointer for new task and return current stack pointer. 

When resulting context gets restored by {\ttfamily \hyperlink{tn__arch_8h_afd5f43f42f5645de164ba6d13d3a4bcf}{\+\_\+tn\+\_\+arch\+\_\+context\+\_\+switch\+\_\+now\+\_\+nosave()}} or {\ttfamily \hyperlink{tn__arch_8h_a28871f82c82d549092930dd4842e2980}{\+\_\+tn\+\_\+arch\+\_\+context\+\_\+switch\+\_\+pend()}}, the following conditions should be met\+:


\begin{DoxyItemize}
\item Interrupts are enabled;
\item Return address is set to {\ttfamily \hyperlink{tn__tasks_8h_a23e562731e616f01e325bc9830bcc021}{tn\+\_\+task\+\_\+exit()}}, so that when task body function returns, {\ttfamily \hyperlink{tn__tasks_8h_a23e562731e616f01e325bc9830bcc021}{tn\+\_\+task\+\_\+exit()}} gets automatially called;
\item Argument 0 contains {\ttfamily param} pointer
\end{DoxyItemize}


\begin{DoxyParams}{Parameters}
{\em task\+\_\+func} & Pointer to task body function. \\
\hline
{\em stack\+\_\+top} & Top of the stack, returned by {\ttfamily \hyperlink{tn__arch_8h_a8b4910c153815699beca8afdea88e4b5}{\+\_\+tn\+\_\+arch\+\_\+stack\+\_\+top\+\_\+get()}}. \\
\hline
{\em param} & User-\/provided parameter for task body function.\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
current stack pointer (top of the stack) 
\end{DoxyReturn}
\hypertarget{tn__arch_8h_a28871f82c82d549092930dd4842e2980}{\index{tn\+\_\+arch.\+h@{tn\+\_\+arch.\+h}!\+\_\+tn\+\_\+arch\+\_\+context\+\_\+switch\+\_\+pend@{\+\_\+tn\+\_\+arch\+\_\+context\+\_\+switch\+\_\+pend}}
\index{\+\_\+tn\+\_\+arch\+\_\+context\+\_\+switch\+\_\+pend@{\+\_\+tn\+\_\+arch\+\_\+context\+\_\+switch\+\_\+pend}!tn\+\_\+arch.\+h@{tn\+\_\+arch.\+h}}
\subsubsection[{\+\_\+tn\+\_\+arch\+\_\+context\+\_\+switch\+\_\+pend}]{\setlength{\rightskip}{0pt plus 5cm}void \+\_\+tn\+\_\+arch\+\_\+context\+\_\+switch\+\_\+pend (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}}\label{tn__arch_8h_a28871f82c82d549092930dd4842e2980}


Called whenever we need to switch context from one task to another. 

This function typically does N\+O\+T switch context; it merely pends it, that is, it sets appropriate interrupt flag. If current level is an application level, interrupt is fired immediately, and context gets switched.

But, if it's hard or impossible on particular platform to use dedicated interrupt flag, this function may just switch the context on its own.

{\bfseries Preconditions\+:}


\begin{DoxyItemize}
\item interrupts are enabled;
\item {\ttfamily tn\+\_\+curr\+\_\+run\+\_\+task} points to currently running (preempted) task;
\item {\ttfamily tn\+\_\+next\+\_\+task\+\_\+to\+\_\+run} points to new task to run.
\end{DoxyItemize}

{\bfseries Actions to perform in actual context switching routine\+:}


\begin{DoxyItemize}
\item save context of the preempted task to its stack;
\item set {\ttfamily tn\+\_\+curr\+\_\+run\+\_\+task} to {\ttfamily tn\+\_\+next\+\_\+task\+\_\+to\+\_\+run};
\item restore context of the newly activated task from its stack.
\end{DoxyItemize}

\begin{DoxySeeAlso}{See also}
{\ttfamily tn\+\_\+curr\+\_\+run\+\_\+task} 

{\ttfamily tn\+\_\+next\+\_\+task\+\_\+to\+\_\+run} 
\end{DoxySeeAlso}
\hypertarget{tn__arch_8h_afd5f43f42f5645de164ba6d13d3a4bcf}{\index{tn\+\_\+arch.\+h@{tn\+\_\+arch.\+h}!\+\_\+tn\+\_\+arch\+\_\+context\+\_\+switch\+\_\+now\+\_\+nosave@{\+\_\+tn\+\_\+arch\+\_\+context\+\_\+switch\+\_\+now\+\_\+nosave}}
\index{\+\_\+tn\+\_\+arch\+\_\+context\+\_\+switch\+\_\+now\+\_\+nosave@{\+\_\+tn\+\_\+arch\+\_\+context\+\_\+switch\+\_\+now\+\_\+nosave}!tn\+\_\+arch.\+h@{tn\+\_\+arch.\+h}}
\subsubsection[{\+\_\+tn\+\_\+arch\+\_\+context\+\_\+switch\+\_\+now\+\_\+nosave}]{\setlength{\rightskip}{0pt plus 5cm}void \+\_\+tn\+\_\+arch\+\_\+context\+\_\+switch\+\_\+now\+\_\+nosave (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}}\label{tn__arch_8h_afd5f43f42f5645de164ba6d13d3a4bcf}


Called whenever we need to switch context to new task, but don't save current context. 

This happens\+:
\begin{DoxyItemize}
\item At system start, inside {\ttfamily \hyperlink{tn__sys_8h_a62ab25d9d8ca01c02d368968f19e49bf}{tn\+\_\+sys\+\_\+start()}};
\item At task exit, inside {\ttfamily \hyperlink{tn__tasks_8h_a23e562731e616f01e325bc9830bcc021}{tn\+\_\+task\+\_\+exit()}}
\end{DoxyItemize}

This function doesn't pend context switch, it switches context immediately.

{\bfseries Preconditions\+:}


\begin{DoxyItemize}
\item interrupts are disabled;
\item {\ttfamily tn\+\_\+next\+\_\+task\+\_\+to\+\_\+run} is already set to needed task.
\end{DoxyItemize}

{\bfseries Actions to perform\+:}


\begin{DoxyItemize}
\item set {\ttfamily tn\+\_\+curr\+\_\+run\+\_\+task} to {\ttfamily tn\+\_\+next\+\_\+task\+\_\+to\+\_\+run};
\item restore context of the newly activated task from its stack.
\end{DoxyItemize}

\begin{DoxySeeAlso}{See also}
{\ttfamily tn\+\_\+curr\+\_\+run\+\_\+task} 

{\ttfamily tn\+\_\+next\+\_\+task\+\_\+to\+\_\+run} 
\end{DoxySeeAlso}
