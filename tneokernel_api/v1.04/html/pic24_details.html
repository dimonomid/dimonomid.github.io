<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>TNeoKernel: PIC24/dsPIC details</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-7163754-5', 'auto');
  ga('send', 'pageview');
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">TNeoKernel
   &#160;<span id="projectnumber">v1.04</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">PIC24/dsPIC details </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#pic24_context_switch">Context switch</a></li>
<li class="level1"><a href="#pic24_interrupts">Interrupts</a></li>
<li class="level1"><a href="#pic24_bfa">Atomic access to the structure bit field</a></li>
<li class="level1"><a href="#pic24_building">Building</a></li>
</ul>
</div>
<div class="textblock"><p>PIC24/dsPIC port implementation details</p>
<h1><a class="anchor" id="pic24_context_switch"></a>
Context switch</h1>
<p>The context switch is implemented using the external interrupt 0 (<code>INT0</code>). It is handled completely by the kernel, application should never touch it.</p>
<h1><a class="anchor" id="pic24_interrupts"></a>
Interrupts</h1>
<p>For detailed information about interrupts in TNeoKernel, refer to the page <a class="el" href="interrupts.html">Interrupts</a>.</p>
<p>PIC24/dsPIC TNeoKernel port supports nested interrupts. It allows to specify the range of <em>system interrupt priorities</em>. Refer to the section <a class="el" href="interrupts.html#interrupt_types">Interrupt types</a> for details on what is <em>system interrupt</em>.</p>
<p>System interrupts use separate interrupt stack instead of the task's stack. This approach saves a lot of RAM.</p>
<p>The range is specified by just a single number: <code><a class="el" href="tn__cfg__default_8h.html#a4feb7eb34fc2f175167b7496b63c398a" title="Maximum system interrupt priority. ">TN_P24_SYS_IPL</a></code>, which represents maximum <em>system interrupt priority</em>. Here is a list of available priorities and their characteristics:</p>
<ul>
<li>priorities <code>[1 .. <a class="el" href="tn__cfg__default_8h.html#a4feb7eb34fc2f175167b7496b63c398a" title="Maximum system interrupt priority. ">TN_P24_SYS_IPL</a>]</code>:<ul>
<li>Kernel services <b>are</b> allowed to call;</li>
<li>The macro <code><a class="el" href="tn__arch__pic24_8h.html#a0b184d3c15066f5504144379d2624ff3" title="ISR wrapper macro for software context saving. ">tn_p24_soft_isr()</a></code> <b>must</b> be used.</li>
<li>Separate interrupt stack is used by ISR;</li>
<li>Interrupts get disabled for short periods of time when modifying critical kernel data (for about 100 cycles or the like).</li>
</ul>
</li>
<li>priorities <code>[(<a class="el" href="tn__cfg__default_8h.html#a4feb7eb34fc2f175167b7496b63c398a" title="Maximum system interrupt priority. ">TN_P24_SYS_IPL</a> + 1) .. 6]</code>:<ul>
<li>Kernel services <b>are not</b> allowed to call;</li>
<li>The macro <code><a class="el" href="tn__arch__pic24_8h.html#a0b184d3c15066f5504144379d2624ff3" title="ISR wrapper macro for software context saving. ">tn_p24_soft_isr()</a></code> <b>must not</b> be used.</li>
<li>Task's stack is used by ISR;</li>
<li>Interrupts are not disabled when modifying critical kernel data, but they are disabled for 4..8 cycles by <code>disi</code> instruction when entering/exiting system ISR: we need to safely modify <code>SP</code> and <code>SPLIM</code>.</li>
</ul>
</li>
<li>priority <code>7</code>:<ul>
<li>Kernel services <b>are not</b> allowed to call;</li>
<li>The macro <code><a class="el" href="tn__arch__pic24_8h.html#a0b184d3c15066f5504144379d2624ff3" title="ISR wrapper macro for software context saving. ">tn_p24_soft_isr()</a></code> <b>must not</b> be used.</li>
<li>Task's stack is used by ISR;</li>
<li>Interrupts are never disabled by the kernel. Note that <code>disi</code> instruction leaves interrupts of priority 7 enabled.</li>
</ul>
</li>
</ul>
<p>The kernel provides C-language macro for calling C-language <b>system</b> interrupt service routines.</p>
<p>Usage is as follows:</p>
<div class="fragment"><div class="line"><span class="comment">/* </span></div>
<div class="line"><span class="comment"> * Timer 1 interrupt handler using software interrupt context saving,  </span></div>
<div class="line"><span class="comment"> * PSV is handled automatically:</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><a class="code" href="tn__arch__pic24_8h.html#a0b184d3c15066f5504144379d2624ff3">tn_p24_soft_isr</a>(_T1Interrupt, auto_psv)</div>
<div class="line">{</div>
<div class="line">   <span class="comment">//-- clear interrupt flag</span></div>
<div class="line">   IFS0bits.T1IF = 0;</div>
<div class="line"></div>
<div class="line">   <span class="comment">//-- do something useful</span></div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section attention"><dt>Attention</dt><dd>do <b>not</b> use this macro for non-system interrupt (that is, for interrupt of priority higher than <code><a class="el" href="tn__cfg__default_8h.html#a4feb7eb34fc2f175167b7496b63c398a" title="Maximum system interrupt priority. ">TN_P24_SYS_IPL</a></code>). Use standard way to define it. If you violate this rule, debugger will be halted by the kernel when entering ISR. In release build, CPU is just reset.</dd></dl>
<h1><a class="anchor" id="pic24_bfa"></a>
Atomic access to the structure bit field</h1>
<p>The problem with PIC24/dsPIC is that when we write something like:</p>
<div class="fragment"><div class="line">IPC0bits.INT0IP = 0x05;</div>
</div><!-- fragment --><p>We actually have read-modify-write sequence which can be interrupted, so that resulting data could be corrupted. PIC24/dsPIC port provides several macros that offer atomic access to the structure bit field.</p>
<p>The kernel would not probably provide that kind of functionality, but TNeoKernel itself needs it, so, it is made public so that application can use it too.</p>
<p>Refer to the page <a class="el" href="tn__arch__pic24__bfa_8h.html">Atomic bit-field access macros</a> for details.</p>
<h1><a class="anchor" id="pic24_building"></a>
Building</h1>
<p>For generic information on building TNeoKernel, refer to the page <a class="el" href="building.html">Building the project</a>.</p>
<p>MPLABX project for PIC24/dsPIC port resides in the <code>src/arch/pic24_dspic/tneokernel_pic24_dspic.X</code> directory. This is a <em>library project</em> in terms of MPLABX, so if you use MPLABX you can easily add it to your main project by right-clicking <code>Libraries -&gt; Add Library Project ...</code>.</p>
<dl class="section attention"><dt>Attention</dt><dd>there are two configurations of this project: <em>eds</em> and <em> no_eds</em>, for devices with and without extended data space, respectively. When you add library project to your application project, you should select correct configuration for your device; otherwise, you get "undefined reference" errors at linker step.</dd></dl>
<p>Alternatively, of course you can just build it and use resulting <code>.a</code> file in whatever way you like. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Nov 4 2014 04:27:59 for TNeoKernel by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.8
</small></address>
</body>
</html>
