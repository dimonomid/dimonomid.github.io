<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>TNeoKernel: Quick guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-7163754-5', 'auto');
  ga('send', 'pageview');
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">TNeoKernel
   &#160;<span id="projectnumber">v1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Quick guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#time_ticks">Time ticks</a></li>
<li class="level1"><a href="#starting_the_kernel">Starting the kernel</a></li>
<li class="level1"><a href="#round_robin">Round-robin scheduling</a></li>
</ul>
</div>
<div class="textblock"><p>This page contains quick guide on system startup and important implementation details.</p>
<h1><a class="anchor" id="time_ticks"></a>
Time ticks</h1>
<p>For the purpose of calculating timeouts, the kernel uses a time tick timer. In TNeoKernel, this time tick timer must to be a some kind of hardware timer that produces interrupt for time ticks processing. Throughout this text, this timer is referred to as <em>system timer</em>. The period of this timer is determined by user (typically 1 ms, but user is free to set different value). In the ISR for this timer, it is only necessary to call the <code><a class="el" href="tn__sys_8h.html#a944d96c7a5d442d271115b6cb22a085b" title="Process system tick; should be called periodically, typically from some kind of timer ISR...">tn_tick_int_processing()</a></code> function:</p>
<div class="fragment"><div class="line"><span class="comment">//-- example for PIC32, hardware timer 5 interrupt:</span></div>
<div class="line"><a class="code" href="tn__arch__pic32_8h.html#a46a860d030e59e2c6aa827ca5ad36a37">tn_soft_isr</a>(_TIMER_5_VECTOR)</div>
<div class="line">{</div>
<div class="line">   INTClearFlag(INT_T5);</div>
<div class="line">   <a class="code" href="tn__sys_8h.html#a944d96c7a5d442d271115b6cb22a085b">tn_tick_int_processing</a>();</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="starting_the_kernel"></a>
Starting the kernel</h1>
<h3>Quick guide on startup process</h3>
<ul>
<li>You allocate arrays for idle task stack and interrupt stack, there is a convenience macro <code><a class="el" href="tn__tasks_8h.html#a120e01d9dddd21ac11827595e88d7c36" title="Convenience macro for the definition of stack array. ">TN_TASK_STACK_DEF()</a></code> for that. It is good idea to consult the <code><a class="el" href="tn__arch__example_8h.html#ad465f81e8ea15a530747b1147dbe4605" title="Minimum task&#39;s stack size, in words, not in bytes; includes a space for context plus for parameters p...">TN_MIN_STACK_SIZE</a></code> to determine stack sizes (see example below).</li>
<li>You provide callback function like <code>void init_task_create(void) { ... }</code>, in which at least one (and typically just one) your own task should be created and activated. This task should perform application initialization and create all the rest of tasks. See details in <code><a class="el" href="tn__sys_8h.html#a94f785ff88dfca8746f34de59784883d" title="User-provided callback function that is called directly from tn_sys_start() as a part of system start...">TN_CBUserTaskCreate()</a></code>.</li>
<li>You provide idle callback function to be called periodically from idle task. It's quite fine to leave it empty.</li>
<li>In the <code>main()</code> you should:<ul>
<li>disable interrupts globally by calling <code><a class="el" href="tn__arch_8h.html#a2b3f2294ac42a599662c573394b14c75" title="Unconditionally disable interrupts. ">tn_arch_int_dis()</a></code>;</li>
<li>perform some essential CPU configuration, such as oscillator settings and similar things.</li>
<li>setup <em>system timer</em> interrupt (from which <code><a class="el" href="tn__sys_8h.html#a944d96c7a5d442d271115b6cb22a085b" title="Process system tick; should be called periodically, typically from some kind of timer ISR...">tn_tick_int_processing()</a></code> gets called)</li>
<li>perform any platform-dependent required actions (say, on PIC32 you should enable core software interrupt 0 with the lowest priority)</li>
<li>call <code><a class="el" href="tn__sys_8h.html#a62ab25d9d8ca01c02d368968f19e49bf" title="Initial TNeoKernel system start function, never returns. ">tn_sys_start()</a></code> providing all necessary information: pointers to stacks, their sizes and your callback functions.</li>
</ul>
</li>
<li>Kernel acts as follows:<ul>
<li>performs all necessary housekeeping;</li>
<li>creates idle task;</li>
<li>calls your <code><a class="el" href="tn__sys_8h.html#a94f785ff88dfca8746f34de59784883d" title="User-provided callback function that is called directly from tn_sys_start() as a part of system start...">TN_CBUserTaskCreate()</a></code> callback, in which your initial task is created with <code><a class="el" href="tn__tasks_8h.html#a8fa2ef577d6bd159b3fae559839f98d5a0c9352496e4465eb7e1b29dab7544acc" title="whether task should be activated right after it is created. ">TN_TASK_CREATE_OPT_START</a></code> option;</li>
<li>performs first context switch (to your task with highest priority).</li>
</ul>
</li>
<li>At this point, system operates normally: your initial task gets executed and you can call whatever system services you need. Typically, your initial task acts then as follows:<ul>
<li>Perform initialization of various on-board peripherals (displays, flash memory chips, or whatever);</li>
<li>Initialize software modules used by application;</li>
<li>Create all the rest of your tasks (since everything is initialized already so that they can proceed with their job);</li>
<li>Eventually, perform its primary job (the job for which task was created at all).</li>
</ul>
</li>
</ul>
<h3>Basic example for PIC32</h3>
<p>This example project can be found in the TNeoKernel repository, in the <code>examples/pic32/basic</code> directory.</p>
<dl class="section attention"><dt>Attention</dt><dd>Before trying to build examples, please read <a class="el" href="building.html">Building the project</a> page carefully: you need to copy configuration file in the tneokernel directory to build it. Each example has <code>tn_cfg_appl.h</code> file, and you should either create a symbolic link to this file from <code>tneokernel/src/tn_cfg.h</code> or just copy this file as <code>tneokernel/src/tn_cfg.h</code>.</dd></dl>
<div class="fragment"><div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * TNeoKernel PIC32 basic example</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment"> *    INCLUDED FILES</span></div>
<div class="line"><span class="comment"> ******************************************************************************/</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;xc.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;plib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="tn_8h.html">tn.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment"> *    PIC32 HARDWARE CONFIGURATION</span></div>
<div class="line"><span class="comment"> ******************************************************************************/</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#pragma config FNOSC    = PRIPLL        // Oscillator Selection</span></div>
<div class="line"><span class="preprocessor">#pragma config FPLLIDIV = DIV_4         // PLL Input Divider (PIC32 Starter Kit: use divide by 2 only)</span></div>
<div class="line"><span class="preprocessor">#pragma config FPLLMUL  = MUL_20        // PLL Multiplier</span></div>
<div class="line"><span class="preprocessor">#pragma config FPLLODIV = DIV_1         // PLL Output Divider</span></div>
<div class="line"><span class="preprocessor">#pragma config FPBDIV   = DIV_2         // Peripheral Clock divisor</span></div>
<div class="line"><span class="preprocessor">#pragma config FWDTEN   = OFF           // Watchdog Timer</span></div>
<div class="line"><span class="preprocessor">#pragma config WDTPS    = PS1           // Watchdog Timer Postscale</span></div>
<div class="line"><span class="preprocessor">#pragma config FCKSM    = CSDCMD        // Clock Switching &amp; Fail Safe Clock Monitor</span></div>
<div class="line"><span class="preprocessor">#pragma config OSCIOFNC = OFF           // CLKO Enable</span></div>
<div class="line"><span class="preprocessor">#pragma config POSCMOD  = HS            // Primary Oscillator</span></div>
<div class="line"><span class="preprocessor">#pragma config IESO     = OFF           // Internal/External Switch-over</span></div>
<div class="line"><span class="preprocessor">#pragma config FSOSCEN  = OFF           // Secondary Oscillator Enable</span></div>
<div class="line"><span class="preprocessor">#pragma config CP       = OFF           // Code Protect</span></div>
<div class="line"><span class="preprocessor">#pragma config BWP      = OFF           // Boot Flash Write Protect</span></div>
<div class="line"><span class="preprocessor">#pragma config PWP      = OFF           // Program Flash Write Protect</span></div>
<div class="line"><span class="preprocessor">#pragma config ICESEL   = ICS_PGx2      // ICE/ICD Comm Channel Select</span></div>
<div class="line"><span class="preprocessor">#pragma config DEBUG    = OFF           // Debugger Disabled for Starter Kit</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment"> *    MACROS</span></div>
<div class="line"><span class="comment"> ******************************************************************************/</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//-- instruction that causes debugger to halt</span></div>
<div class="line"><span class="preprocessor">#define PIC32_SOFTWARE_BREAK()  __asm__ volatile (&quot;sdbbp 0&quot;)</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//-- system frequency</span></div>
<div class="line"><span class="preprocessor">#define SYS_FREQ           80000000UL</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//-- peripheral bus frequency</span></div>
<div class="line"><span class="preprocessor">#define PB_FREQ            40000000UL</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//-- kernel ticks (system timer) frequency</span></div>
<div class="line"><span class="preprocessor">#define SYS_TMR_FREQ       1000</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//-- system timer prescaler</span></div>
<div class="line"><span class="preprocessor">#define SYS_TMR_PRESCALER           T5_PS_1_8</span></div>
<div class="line"><span class="preprocessor">#define SYS_TMR_PRESCALER_VALUE     8</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//-- system timer period (auto-calculated)</span></div>
<div class="line"><span class="preprocessor">#define SYS_TMR_PERIOD              \</span></div>
<div class="line"><span class="preprocessor">   (PB_FREQ / SYS_TMR_PRESCALER_VALUE / SYS_TMR_FREQ)</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//-- idle task stack size, in words</span></div>
<div class="line"><span class="preprocessor">#define IDLE_TASK_STACK_SIZE          (TN_MIN_STACK_SIZE + 16)</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//-- interrupt stack size, in words</span></div>
<div class="line"><span class="preprocessor">#define INTERRUPT_STACK_SIZE          (TN_MIN_STACK_SIZE + 64)</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//-- stack sizes of user tasks</span></div>
<div class="line"><span class="preprocessor">#define TASK_A_STK_SIZE    (TN_MIN_STACK_SIZE + 96)</span></div>
<div class="line"><span class="preprocessor">#define TASK_B_STK_SIZE    (TN_MIN_STACK_SIZE + 96)</span></div>
<div class="line"><span class="preprocessor">#define TASK_C_STK_SIZE    (TN_MIN_STACK_SIZE + 96)</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//-- user task priorities</span></div>
<div class="line"><span class="preprocessor">#define TASK_A_PRIORITY    7</span></div>
<div class="line"><span class="preprocessor">#define TASK_B_PRIORITY    6</span></div>
<div class="line"><span class="preprocessor">#define TASK_C_PRIORITY    5</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment"> *    DATA</span></div>
<div class="line"><span class="comment"> ******************************************************************************/</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//-- Allocate arrays for stacks: stack for idle task</span></div>
<div class="line"><span class="comment">//   and for interrupts are the requirement of the kernel;</span></div>
<div class="line"><span class="comment">//   others are application-dependent.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//   We use convenience macro TN_TASK_STACK_DEF() for that.</span></div>
<div class="line"></div>
<div class="line"><a class="code" href="tn__tasks_8h.html#a120e01d9dddd21ac11827595e88d7c36">TN_TASK_STACK_DEF</a>(idle_task_stack, IDLE_TASK_STACK_SIZE);</div>
<div class="line"><a class="code" href="tn__tasks_8h.html#a120e01d9dddd21ac11827595e88d7c36">TN_TASK_STACK_DEF</a>(interrupt_stack, INTERRUPT_STACK_SIZE);</div>
<div class="line"></div>
<div class="line"><a class="code" href="tn__tasks_8h.html#a120e01d9dddd21ac11827595e88d7c36">TN_TASK_STACK_DEF</a>(task_a_stack, TASK_A_STK_SIZE);</div>
<div class="line"><a class="code" href="tn__tasks_8h.html#a120e01d9dddd21ac11827595e88d7c36">TN_TASK_STACK_DEF</a>(task_b_stack, TASK_B_STK_SIZE);</div>
<div class="line"><a class="code" href="tn__tasks_8h.html#a120e01d9dddd21ac11827595e88d7c36">TN_TASK_STACK_DEF</a>(task_c_stack, TASK_C_STK_SIZE);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//-- task structures</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span><a class="code" href="structTN__Task.html">TN_Task</a> task_a = {};</div>
<div class="line"><span class="keyword">struct </span><a class="code" href="structTN__Task.html">TN_Task</a> task_b = {};</div>
<div class="line"><span class="keyword">struct </span><a class="code" href="structTN__Task.html">TN_Task</a> task_c = {};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment"> *    ISRs</span></div>
<div class="line"><span class="comment"> ******************************************************************************/</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * system timer ISR</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><a class="code" href="tn__arch__pic32_8h.html#a46a860d030e59e2c6aa827ca5ad36a37">tn_soft_isr</a>(_TIMER_5_VECTOR)</div>
<div class="line">{</div>
<div class="line">   INTClearFlag(INT_T5);</div>
<div class="line">   <a class="code" href="tn__sys_8h.html#a944d96c7a5d442d271115b6cb22a085b">tn_tick_int_processing</a>();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment"> *    FUNCTIONS</span></div>
<div class="line"><span class="comment"> ******************************************************************************/</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> appl_init(<span class="keywordtype">void</span>);</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> task_a_body(<span class="keywordtype">void</span> *par)</div>
<div class="line">{</div>
<div class="line">   <span class="comment">//-- this is a first created application task, so it needs to perform</span></div>
<div class="line">   <span class="comment">//   all the application initialization.</span></div>
<div class="line">   appl_init();</div>
<div class="line"></div>
<div class="line">   <span class="comment">//-- and then, let&#39;s get to the primary job of the task</span></div>
<div class="line">   <span class="comment">//   (job for which task was created at all)</span></div>
<div class="line">   <span class="keywordflow">for</span>(;;)</div>
<div class="line">   {</div>
<div class="line">      mPORTEToggleBits(BIT_0);</div>
<div class="line">      <a class="code" href="tn__tasks_8h.html#ad3708ae3400f11b98747ad4a1cad88fa">tn_task_sleep</a>(500);</div>
<div class="line">   }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> task_b_body(<span class="keywordtype">void</span> *par)</div>
<div class="line">{</div>
<div class="line">   <span class="keywordflow">for</span>(;;)</div>
<div class="line">   {</div>
<div class="line">      mPORTEToggleBits(BIT_1);</div>
<div class="line">      <a class="code" href="tn__tasks_8h.html#ad3708ae3400f11b98747ad4a1cad88fa">tn_task_sleep</a>(1000);</div>
<div class="line">   }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> task_c_body(<span class="keywordtype">void</span> *par)</div>
<div class="line">{</div>
<div class="line">   <span class="keywordflow">for</span>(;;)</div>
<div class="line">   {</div>
<div class="line">      mPORTEToggleBits(BIT_2);</div>
<div class="line">      <a class="code" href="tn__tasks_8h.html#ad3708ae3400f11b98747ad4a1cad88fa">tn_task_sleep</a>(1500);</div>
<div class="line">   }</div>
<div class="line">}</div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * Hardware init: called from main() with interrupts disabled</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">void</span> hw_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">   SYSTEMConfig(SYS_FREQ, SYS_CFG_WAIT_STATES | SYS_CFG_PCACHE);</div>
<div class="line"></div>
<div class="line">   <span class="comment">//turn off ADC function for all pins</span></div>
<div class="line">   AD1PCFG = 0xffffffff;</div>
<div class="line"></div>
<div class="line">   <span class="comment">//-- enable timer5 interrupt</span></div>
<div class="line">   OpenTimer5((0</div>
<div class="line">            | T5_ON</div>
<div class="line">            | T5_IDLE_STOP</div>
<div class="line">            | SYS_TMR_PRESCALER</div>
<div class="line">            | T5_SOURCE_INT</div>
<div class="line">            ),</div>
<div class="line">         (SYS_TMR_PERIOD - 1)</div>
<div class="line">         );</div>
<div class="line"></div>
<div class="line">   <span class="comment">//-- set timer5 interrupt priority to 2, enable it</span></div>
<div class="line">   INTSetVectorPriority(INT_TIMER_5_VECTOR, INT_PRIORITY_LEVEL_2);</div>
<div class="line">   INTSetVectorSubPriority(INT_TIMER_5_VECTOR, INT_SUB_PRIORITY_LEVEL_0);</div>
<div class="line">   INTClearFlag(INT_T5);</div>
<div class="line">   INTEnable(INT_T5, INT_ENABLED);</div>
<div class="line"></div>
<div class="line">   <span class="comment">//-- TNeoKernel PIC32 requirement:</span></div>
<div class="line">   <span class="comment">//   set up the software interrupt 0 with a priority of 1, subpriority 0</span></div>
<div class="line">   <span class="comment">//</span></div>
<div class="line">   <span class="comment">//   NOTE: the ISR is declared in kernel-provided file </span></div>
<div class="line">   <span class="comment">//   tn_arch_pic32_int_vec1.S, which should be included in the application</span></div>
<div class="line">   <span class="comment">//   project itself, in order to dispatch vector correctly.</span></div>
<div class="line">   INTSetVectorPriority(INT_CORE_SOFTWARE_0_VECTOR, INT_PRIORITY_LEVEL_1);</div>
<div class="line">   INTSetVectorSubPriority(INT_CORE_SOFTWARE_0_VECTOR, INT_SUB_PRIORITY_LEVEL_0);</div>
<div class="line">   INTClearFlag(INT_CS0);</div>
<div class="line">   INTEnable(INT_CS0, INT_ENABLED);</div>
<div class="line"></div>
<div class="line">   <span class="comment">//-- configure LED port pins</span></div>
<div class="line">   mPORTESetPinsDigitalOut(BIT_0 | BIT_1 | BIT_2);</div>
<div class="line">   mPORTEClearBits(BIT_0 | BIT_1 | BIT_2);</div>
<div class="line"></div>
<div class="line">   <span class="comment">//-- enable multi-vectored interrupt mode</span></div>
<div class="line">   INTConfigureSystem(INT_SYSTEM_CONFIG_MULT_VECTOR);</div>
<div class="line">}</div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * Application init: called from the first created application task</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">void</span> appl_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">   <span class="comment">//-- initialize various on-board peripherals, such as</span></div>
<div class="line">   <span class="comment">//   flash memory, displays, etc.</span></div>
<div class="line">   <span class="comment">//   (in this sample project there&#39;s nothing to init)</span></div>
<div class="line"></div>
<div class="line">   <span class="comment">//-- initialize various program modules</span></div>
<div class="line">   <span class="comment">//   (in this sample project there&#39;s nothing to init)</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">   <span class="comment">//-- create all the rest application tasks</span></div>
<div class="line">   <a class="code" href="tn__tasks_8h.html#a548d5adda09d1b4e393b5df0e9e1a7a5">tn_task_create</a>(</div>
<div class="line">         &amp;task_b,</div>
<div class="line">         task_b_body,</div>
<div class="line">         TASK_B_PRIORITY,</div>
<div class="line">         task_b_stack,</div>
<div class="line">         TASK_B_STK_SIZE,</div>
<div class="line">         <a class="code" href="tn__common_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div>
<div class="line">         (<a class="code" href="tn__tasks_8h.html#a8fa2ef577d6bd159b3fae559839f98d5a0c9352496e4465eb7e1b29dab7544acc">TN_TASK_CREATE_OPT_START</a>)</div>
<div class="line">         );</div>
<div class="line"></div>
<div class="line">   <a class="code" href="tn__tasks_8h.html#a548d5adda09d1b4e393b5df0e9e1a7a5">tn_task_create</a>(</div>
<div class="line">         &amp;task_c,</div>
<div class="line">         task_c_body,</div>
<div class="line">         TASK_C_PRIORITY,</div>
<div class="line">         task_c_stack,</div>
<div class="line">         TASK_C_STK_SIZE,</div>
<div class="line">         <a class="code" href="tn__common_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div>
<div class="line">         (<a class="code" href="tn__tasks_8h.html#a8fa2ef577d6bd159b3fae559839f98d5a0c9352496e4465eb7e1b29dab7544acc">TN_TASK_CREATE_OPT_START</a>)</div>
<div class="line">         );</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//-- idle callback that is called periodically from idle task</span></div>
<div class="line"><span class="keywordtype">void</span> idle_task_callback (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//-- create first application task(s)</span></div>
<div class="line"><span class="keywordtype">void</span> init_task_create(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">   <span class="comment">//-- task A performs complete application initialization,</span></div>
<div class="line">   <span class="comment">//   it&#39;s the first created application task</span></div>
<div class="line">   <a class="code" href="tn__tasks_8h.html#a548d5adda09d1b4e393b5df0e9e1a7a5">tn_task_create</a>(</div>
<div class="line">         &amp;task_a,                   <span class="comment">//-- task structure</span></div>
<div class="line">         task_a_body,               <span class="comment">//-- task body function</span></div>
<div class="line">         TASK_A_PRIORITY,           <span class="comment">//-- task priority</span></div>
<div class="line">         task_a_stack,              <span class="comment">//-- task stack</span></div>
<div class="line">         TASK_A_STK_SIZE,           <span class="comment">//-- task stack size (in words)</span></div>
<div class="line">         <a class="code" href="tn__common_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,                      <span class="comment">//-- task function parameter</span></div>
<div class="line">         <a class="code" href="tn__tasks_8h.html#a8fa2ef577d6bd159b3fae559839f98d5a0c9352496e4465eb7e1b29dab7544acc">TN_TASK_CREATE_OPT_START</a>   <span class="comment">//-- creation option</span></div>
<div class="line">         );</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">int32_t main(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line"><span class="preprocessor">#ifndef PIC32_STARTER_KIT</span></div>
<div class="line">   <span class="comment">/*The JTAG is on by default on POR.  A PIC32 Starter Kit uses the JTAG, but</span></div>
<div class="line"><span class="comment">     for other debug tool use, like ICD 3 and Real ICE, the JTAG should be off</span></div>
<div class="line"><span class="comment">     to free up the JTAG I/O */</span></div>
<div class="line">   DDPCONbits.JTAGEN = 0;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line">   <span class="comment">//-- unconditionally disable interrupts</span></div>
<div class="line">   <a class="code" href="tn__arch_8h.html#a2b3f2294ac42a599662c573394b14c75">tn_arch_int_dis</a>();</div>
<div class="line"></div>
<div class="line">   <span class="comment">//-- init hardware</span></div>
<div class="line">   hw_init();</div>
<div class="line"></div>
<div class="line">   <span class="comment">//-- call to tn_sys_start() never returns</span></div>
<div class="line">   <a class="code" href="tn__sys_8h.html#a62ab25d9d8ca01c02d368968f19e49bf">tn_sys_start</a>(</div>
<div class="line">         idle_task_stack,</div>
<div class="line">         IDLE_TASK_STACK_SIZE,</div>
<div class="line">         interrupt_stack,</div>
<div class="line">         INTERRUPT_STACK_SIZE,</div>
<div class="line">         init_task_create,</div>
<div class="line">         idle_task_callback</div>
<div class="line">         );</div>
<div class="line"></div>
<div class="line">   <span class="comment">//-- unreachable</span></div>
<div class="line">   <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> __attribute__((naked, nomips16, noreturn)) _general_exception_handler(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">   PIC32_SOFTWARE_BREAK();</div>
<div class="line">   <span class="keywordflow">for</span> (;;) ;</div>
<div class="line">}</div>
<div class="line"></div>
</div><!-- fragment --><h1><a class="anchor" id="round_robin"></a>
Round-robin scheduling</h1>
<p>TNKernel has the ability to make round robin scheduling for tasks with identical priority. By default, round robin scheduling is turned off for all priorities. To enable round robin scheduling for tasks on certain priority level and to set time slices for these priority, user must call the <code><a class="el" href="tn__sys_8h.html#a05fc370b6faa604fd8ff9411361c4cd0" title="Set time slice ticks value for specified priority (see Round-robin scheduling). ">tn_sys_tslice_set()</a></code> function. The time slice value is the same for all tasks with identical priority but may be different for each priority level. If the round robin scheduling is enabled, every system time tick interrupt increments the currently running task time slice counter. When the time slice interval is completed, the task is placed at the tail of the ready to run queue of its priority level (this queue contains tasks in the <a class="el" href="tn__tasks_8h.html#a5e12e8a0ab280b515f44bf3fee1210a6a02783ac7808aeda318a6f506b7a276dc"><code>RUNNABLE</code></a> state) and the time slice counter is cleared. Then the task may be preempted by tasks of higher or equal priority.</p>
<p>In most cases, there is no reason to enable round robin scheduling. For applications running multiple copies of the same code, however, (GUI windows, etc), round robin scheduling is an acceptable solution. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Oct 2 2014 03:07:03 for TNeoKernel by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.8
</small></address>
</body>
</html>
